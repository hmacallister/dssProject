<!DOCTYPE html>
<html ng-app>

	<head>

		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="">
		<meta name="author" content="">

		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.min.js"></script>
		<title>Library Upload</title>

	</head>

	<body ng-controller="fileLoader">
		<!-- 		<button id="logOut" type="submit" class="btn btn-default" onclick="eraseCookie('usercookie')"> -->
		<!-- 			Log Out -->
		<!-- 		</button> -->

		<div id="uploadPanel" align="center">
			<h1>Registration Successful! <small>Welcome new user</small></h1>
			<h2> Import <small>Your Library</small></h2>
			<!--<h1>File Upload</h1>-->
			<form method="post" action="UploadServlet" enctype="multipart/form-data" style="display: inline-block">
				Select file to upload to server:
				<input type="file" class="btn btn-default" name="file" size="60" accept=".xml" style="background-color: gray;"/>
				<br>
				<button type="submit" class="btn btn-default">
					Upload To Server
				</button>
			</form>
			<br>
			<br>
			<h4 id="server-reponse"></h4>
			<br>
				<input id="homeButton" value ="Home" type="hidden" class="btn btn-default" onclick="createUserCookie()"/>
		</div>

		<!-- jQuery -->
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.4.4.min.js"></script>

		<script>
			var x = readCookie('usercookie')
			if (!x) {
				window.location.replace("/dss/login.html");
			}

			function hideButton() {
				var buttn = document.getElementById("submitButton");
				var parent = buttn.parentNode;
				parent.removeChild(buttn);

				var temp = jQuery('#form').submit();
				return true;
			}

			function createCookie(name, value, days) {
				if (days) {
					var date = new Date();
					date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
					var expires = "; expires=" + date.toGMTString();
				} else
					var expires = "";
				document.cookie = name + "=" + value + expires + "; path=/";
			}

			function readCookie(name) {
				var nameEQ = name + "=";
				var ca = document.cookie.split(';');
				for (var i = 0; i < ca.length; i++) {
					var c = ca[i];
					while (c.charAt(0) == ' ')
					c = c.substring(1, c.length);
					if (c.indexOf(nameEQ) == 0)
						return c.substring(nameEQ.length, c.length);
				}
				return null;
			}

			function eraseCookie(name) {
				createCookie(name, "", -1);
				window.location.replace("/dss/login.html");
			}

			function fileLoader($scope, $http) {
				$http.get('/dss/rest/file').success(function(data) {
					$scope.files = data;
				});
			}
		</script>
		<script>
			//alert(window.location.hash);
			var response = window.location.hash;
			var len = response.length;
			var elem = document.getElementById("server-reponse");
			if (len > 2) {
				elem.innerHTML = "Server Response:" + response + "<br>User Profile now complete!";
				document.getElementById("homeButton").type = "submit";
			}

			function createUserCookie() {
				var libraryPersistentID = "";
				var username = x.split('username":"');
				var usersplit = username[1].substring(0, username[1].length - 2);
				var passwordsplit = (usersplit.split('","password'));
				var userID = passwordsplit[0];
				alert(userID);

				(function($) {
					$.ajax({
						url : '/dss/rest/users/getuserbyname',
						dataType : 'json',
						type : 'post',
						contentType : 'application/json',
						data : JSON.stringify({
							"username" : userID,
							"password" : "hhh",
							"libraryPersistentID" : "TEMPORARY ID"
						}),
						processData : false,
						success : function(data, textStatus, jQxhr) {
							var elem = document.getElementById("server-reponse");
							if (data != null) {
								createCookie('usercookie', JSON.stringify(data), 0);
								var key = 'libraryPersistentID';
								if (data[key] != -1) {
									alert("Registration Successful");
									window.location.replace("index.html");
								} else {
									elem.innerHTML = "Login Failed: wrong username or password";
									elem.style.color = 'red';
								}
							} else {
								elem.innerHTML = "Username already exists! Please try another!";
								elem.style.color = 'red';
								console.log(errorThrown);
							}
						},
						error : function(jqXhr, textStatus, errorThrown) {
							createCookie('usercookie', "", 0);
							document.write('<p>Unknown Error!!!! This should not happen</p><a href ="login.html">Continue</a>');
							console.log(errorThrown);

						}
					});

				})(jQuery);
				//end anonymous inner function
			}
		</script>

		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

	</body>

</html>