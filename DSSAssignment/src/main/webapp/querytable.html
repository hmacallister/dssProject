<!DOCTYPE html>
<html ng-app>
	<head>

		<meta charset="ISO-8859-1">


		<!-- Bootstrap Core CSS -->
		<link href="css/bootstrap.min.css" rel="stylesheet">

		<!-- Custom Fonts -->
		<link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">		
		
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>
		<script src="http://www.shawnolson.net/scripts/public_smo_scripts.js"></script>
		<script src="sorttable.js"></script>

		<title>Query Viewer</title>
		<script type="text/javascript" id="me">
			//var name = window.name;
			//elem.style.color = 'red';
			
			//var code = name.substring(0, 3);
		</script>
		<style>
		/* Sortable tables */
		table.sortable thead {
   		 	background-color:#eee;
    		color:#666666;
	    	font-weight: bold;
    		cursor: default;
    	}
    	table.sortable th:not(.sorttable_sorted):not(.sorttable_sorted_reverse):not(.sorttable_nosort):after { 
    		content: " \25B4\25BE" 
		}
		
		
		/* Appearance 
    	body, table { font-family: sans-serif; }
    	table { border-collapse: collapse; }
    	td, th { padding: 6px; }
    	th { background: #333; color: white; }
    	tbody tr:nth-child(odd) { background: #dfdfdf; }
    	table { border: 1px solid red; }
    	
    	*/
    
   		 /* Scrollability of table */
    	table { width: 800px; } /* fixed width table */
    	thead tr { display: block; } /* makes it sizeable */
    	tbody { 
    	  display: block; /* makes it sizeable */
    	  height: 300px; /* height of scrollable area */
    	  overflow: auto; /* scroll rather than overflow */
    	  width: 100%; /* fill the box */
    	}
    	thead th { width: 400px; } /* fixed width for THs */
    	tbody td { width: 368px; } /* fixed width for TDs */
    	/* the tbody needs to be 16px less than the thead, for the scrollbar */
    	
    	</style>

		
    
    
	</head>
	<body ng-controller="errorLoader">
		<div id="wrapper">
		<div id="page-wrapper">

			<div class="container-fluid">
				<div class="row">
					<div class="col-lg-6">
						<h2 align="center">Tracks</h2>
					</div>
 		<div class="col-lg-6">
			<input type=submit value ="Save Playlist Order" class="btn btn-default" onclick="saveOrder()">
		</div>
		<hr>
		<div class="col-lg12">
		<div class="table-responsive">
		<table id="trackTable" border=1 class="sortable table table-bordered table-hover table-striped">
			<thead>
				<tr>
					<th class="id">Id</th>
					<th class="title">Title</th>
					<th class="artist">Artist</th>
					<th class="album">Album</th>
					<th class="genre">Genre</th>
					<!--  <th class="trackId">Track Id</th>   -->
					<!--  <th class="userID">User Id</th>  -->
					<th class="sorttable_nosort">Edit Track</th>
					<th class="sorttable_nosort">Delete Track</th>
					<th class="sorttable_nosort">Move Track</th>
				</tr>
			</thead>
			<tbody>
				<tr ng-repeat="record in records" id={{record[0]}}>
					<td class="id">{{record[0]}}</td>
					<td class="title"><input type="text" size="" id=title{{record[0]}} value={{record[1]}}></td>
					<td class="artist"><input type="text" id=artist{{record[0]}} value='{{record[2]}}'></td>
					<td class="album"><input type="text" id=album{{record[0]}} value="{{record[3]}}"></td>
					<td class="genre"><input type="text" id=genre{{record[0]}} value={{record[4]}}></td>
				<!--	<td class="trackId">{{record[5]}}</td>  -->
				<!--	<td class="userID">{{record[6]}}</td>  -->
					<td class="editButton"><input type="submit" value="Edit" onclick="editTrack({{record[0]}})"></td>
					<td class="deleteButton"><input type="submit" value="Delete" onclick="deleteTrack({{record[0]}})"></td>
					<td>Drag to Move</td>
				</tr>
			</tbody>
		</table>
		</div><!-- end table-responsive -->
		</div>
		</div>
		</div>
		</div>
		</div>
		</div>


		<script>

		$(document).ready(function(){
			$('#trackTable tbody').sortable();
		});
		//var myTH = document.getElementsByTagName("th")[0];
		//sorttable.innerSortFunction.apply(myTH, []);
		
		var sortedOrder = "";
		
		//alert("window name = "+window.name);
		
			function errorLoader($scope, $http) {
				var choice = readCookie('choicecookie')
				//alert(choice);
				var sortedTable = window.name;
				if(sortedTable.length > 1 && sortedTable != "formFrame"){
					//alert("reached post method with: "+sortedTable);
					$http.get('/dss/rest/playlists/sort/'+ sortedTable).
			        success(function(data) {
			            alert("sorted!")
			            window.name = "";
			        });
				}
				if(choice.indexOf("searchTerm") != -1){
					var x = readCookie('usercookie')
					var libraryPersistentID = x.split('libraryPersistentID":"');		
					var userID = libraryPersistentID[1].substring(0,libraryPersistentID[1].length-2);
					var searchTerm = choice.split("searchTerm");
					searchTerm = searchTerm[1];
					searchTerm = searchTerm + "--user--"+userID;
					alert("sending: "+searchTerm);
					$http.get('/dss/rest/tracks/getsearch/'+ searchTerm).
			        success(function(data) {
			            $scope.records = data;
			        });
				}
				if(choice == "all"){
					//alert("found match for all")
					var x = readCookie('usercookie')
					var libraryPersistentID = x.split('libraryPersistentID":"');		
					var userID = libraryPersistentID[1].substring(0,libraryPersistentID[1].length-2);
					//alert("view all by user id = "+userID);
					$http.get('/dss/rest/tracks/getlibrary/'+ userID).
			        success(function(data) {
			            $scope.records = data;
			        });
			        
				   // window.top.name = "";	
				}				
				else{
					//alert("choice = "+choice)
					$http.get('/dss/rest/playlists/getplaylistbyId/' + choice).
			        success(function(data) {
			            $scope.records = data;
			        });

				}
				
			}
			
			function deleteTrack(id) {
				alert("id = "+id);
				(function($) {
					$.ajax({
						url : '/dss/rest/tracks/deletetrack',
						dataType : 'json',
						type : 'delete',
						contentType : 'application/json',
						data : JSON.stringify({
							"id" : id
						}),
						processData : false,
						success : function(data, textStatus, jQxhr) {
							alert("Delete Successful");
							window.location.reload();
						},
						error : function(jqXhr, textStatus, errorThrown) {
							alert("Delete Failed");
							console.log(errorThrown);

						}
					});

				})(jQuery);
				//end anonymous inner function
			}
			
			function editTrack(id) {
				alert("id = "+id);
				var title = document.getElementById("title"+id).value;
				var album = document.getElementById("album"+id).value;
				var artist = document.getElementById("artist"+id).value;
				var genre = document.getElementById("genre"+id).value;
				//alert("title = "+title+" album = "+album+" artist = "+artist+" genre = "+genre);

				(function($) {
					$.ajax({
						url : '/dss/rest/tracks/updatetrack',
						dataType : 'json',
						type : 'post',
						contentType : 'application/json',
						data : JSON.stringify({
							"id" : id,
							"title" : title,
							"album" : album,
							"artist" : artist,
							"genre" : genre
						}),
						processData : false,
						success : function(data, textStatus, jQxhr) {
							alert("Edit Successful");
							window.location.reload();
						},
						error : function(jqXhr, textStatus, errorThrown) {
							alert("Edit Failed");
							console.log(errorThrown);

						}
					});

				})(jQuery);
				//end anonymous inner function
			}
			
			function saveOrder(){
				var choice = readCookie('choicecookie');
				sortedOrder = choice;				
				var trackIDs = []
				$('#trackTable tr').each(function(row, tr){
					sortedOrder = sortedOrder 
				        + "id"+$(tr).find('td:eq(0)').text()

				});
				
				window.name = sortedOrder;

				window.location.reload();
				/*
				if(choice != "all"){
					(function($) {
						$.ajax({
							url : '/dss/rest/playlists/updateplaylist',
							dataType : 'json',
							type : 'post',
							contentType : 'application/json',
							data : JSON.stringify({
								"id" : choice,
								"trackTitles" : trackIDs
							}),
							processData : false,
							success : function(data, textStatus, jQxhr) {
								alert("Edit Successful");
								window.location.replace("index.html");
							},
							error : function(jqXhr, textStatus, errorThrown) {
								alert("Edit Failed");
								console.log(errorThrown);

							}
						});

					})(jQuery);
					//end anonymous inner function
				}
				*/
			}
			
			
			var x = readCookie('usercookie')
			if (!x) {
				window.location.replace("/dss/login.html");
			}

			function readCookie(name) {
				var nameEQ = name + "=";
				var ca = document.cookie.split(';');
				for (var i = 0; i < ca.length; i++) {
					var c = ca[i];
					while (c.charAt(0) == ' ')
					c = c.substring(1, c.length);
					if (c.indexOf(nameEQ) == 0) {
						return c.substring(nameEQ.length, c.length);
					}
				}
				return null;
			}
			function createCookie(name, value, days) {
				if (days) {
					var date = new Date();
					date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
					var expires = "; expires=" + date.toGMTString();
				} else
					var expires = "";
				document.cookie = name + "=" + value + expires + "; path=/";
			}

			function eraseCookie(name) {
				createCookie(name, "", -1);
				if(name == "usercookie"){
					window.location.replace("/dss/login.html");
				}
				
			}
		</script>
		   
    
	</body>
</html>