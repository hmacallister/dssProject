<!DOCTYPE html>
<html ng-app>

	<head>

		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="">
		<meta name="author" content="">

		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.min.js"></script>
		<title>Home</title>

		<script>
			function resizeTableFrame() {
				var formFrame = document.getElementById('formFrame');
				formFrame.style.height = formFrame.contentWindow.document.body.scrollHeight + 'px';
			}
		</script>

		<style>
			.hidden {
				display: none;
			}

			.unhidden {
				display: block;
			}
		</style>
		<script>
			function unhide(clickedButton, divID) {
				var item = document.getElementById(divID);
				if (item) {
					if (item.className == 'hidden') {
						item.className = 'unhidden';
					}
				}
			}

		</script>

	</head>

	<body ng-controller="queryReferenceLoader">

		<div id="wrapper">
			<button id="logOut" type="submit" class="btn btn-default" onclick="eraseCookie('usercookie')">
				Log Out
			</button>
			<div id="page-wrapper" align="center">
				<h2>Music Library</h2>

				<div class="panel-body">
					<div id = "selectQueryVisibility" class = "unhidden">
						<button type="submit" id="library"  onclick="viewLibrary()">
							View Library
						</button>
						<form enctype="multipart/form-data" role="form">
							<div class="form-group">
								<label>View Playlist</label>
								<select id="querySelection" class="form-control">
									<option ng-repeat="query in queries" value={{query.title}}>{{query.title}}</option>
								</select>
							</div>
							<div class="form-group">
								<button type="submit" id="select"  onclick="alterQuery()" class="btn btn-default">
									Select
								</button>
							</div>
						</form>
					</div><!-- end selectQueryVisibility  -->
				</div>
			</div>
		</div>

		<div id="parametersAndTableVisibility"  align="center">
			<div class="col-lg-12 text-center">
				<p id="result"></p>
				<iframe id="formFrame" src="querytable.html" frameborder=0 width="100%" height="600"></iframe>
			</div><!-- end parametersAndTableVisibility  -->
		</div>

		</div>
		<!-- /#page-wrapper -->

		</div>
		<!-- /#wrapper -->

		<script>
			var x = readCookie('usercookie')
			//alert(x);
			if (!x) {
				window.location.replace("/dss/login.html");
			}
			else{
				var ID = x.charAt(x.length-3)
				//alert("USER ID: "+userID);
					if(ID==-1 || ID==0){
						eraseCookie('usercookie');
					}
					/*
					if(ID=='D'){
						var libraryPersistentID="";
						var username = x.split('username":"');		
						var usersplit = username[1].substring(0,username[1].length-2);
						var passwordsplit = (usersplit.split('","password'));
						var userID = passwordsplit[0];
						//alert(userID);
						
						$http.get('/dss/rest/users/getuserbyname/'+userID).success(function(data) {
							libraryPersistentID = data;
						});
						alert(libraryPersistentID);
						//alert(x);
						
					}
					*/
										
			}

			function queryReferenceLoader($scope, $http) {
				var x = readCookie('usercookie')
				var libraryPersistentID = x.split('libraryPersistentID":"');		
				var userID = libraryPersistentID[1].substring(0,libraryPersistentID[1].length-2);
				alert(userID);
				$http.get('/dss/rest/playlists/playlistsbyuser/'+userID).success(function(data) {
					$scope.queries = data;
				});
			}

			function readCookie(name) {
				var nameEQ = name + "=";
				var ca = document.cookie.split(';');
				for (var i = 0; i < ca.length; i++) {
					var c = ca[i];
					while (c.charAt(0) == ' ')
					c = c.substring(1, c.length);
					if (c.indexOf(nameEQ) == 0) {
						return c.substring(nameEQ.length, c.length);
					}
				}
				return null;
			}

			function createCookie(name, value, days) {
				if (days) {
					var date = new Date();
					date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
					var expires = "; expires=" + date.toGMTString();
				} else
					var expires = "";
				document.cookie = name + "=" + value + expires + "; path=/";
			}

			function eraseCookie(name) {
				createCookie(name, "", -1);
				window.location.replace("/dss/login.html");
			}

			function viewLibrary() {
				//window.name = "all";
				createCookie('choicecookie', 1, 0);
				formFrame.src = "querytable.html";
			}

			function alterQuery() {
				var choice = document.getElementById('querySelection').value;
				var formFrame = document.getElementById('formFrame');
				var elem = document.getElementById("result")
				/*
				elem.innerHTML = "Choose Another Query: <form role='form' action='index.html'><div class='form-group'><button type='submit' class='btn btn-default'>Queries</button></div></form>";
				elem.style.color = 'black';
				var queryDiv = document.getElementById("selectQueryVisibility");
				queryDiv.className = 'hidden';
				var tableDiv = document.getElementById("parametersAndTableVisibility");
				tableDiv.className = 'unhidden';
				*/
				//window.name = choice;
				createCookie('choicecookie', choice, 0);
				formFrame.src = "querytable.html";

			}
		</script>

	</body>

</html>
