<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="">
		<meta name="author" content="">
		
		
		<title>Login</title>
		<!-- Bootstrap Core CSS -->
		<link href="css/bootstrap.min.css" rel="stylesheet">

		<!-- Custom CSS -->
		<link href="css/sb-admin.css" rel="stylesheet">

		<!-- Morris Charts CSS -->
		<link href="css/plugins/morris.css" rel="stylesheet">

		<!-- Custom Fonts -->
		<link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
		
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.4.4.min.js"></script>
			
	</head>
	<body>
	
	<div id="wrapper">

			<!-- Navigation -->
			<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="alt_index.html" id = "userDashboardTitle"></a>
				</div>
				<!-- Top Menu Items -->
				<ul class="nav navbar-right top-nav">
					<li class="dropdown">
				</ul>
				<!-- Sidebar Menu Items - These collapse to the responsive navigation menu on small screens -->
				<div class="collapse navbar-collapse navbar-ex1-collapse">
					<ul class="nav navbar-nav side-nav">
					</ul>
				</div>
				<!-- /.navbar-collapse -->
			</nav>

			<div id="page-wrapper">

				<div class="container-fluid">

					<!-- Page Heading -->
					<div class="row">
					<div class="col-lg-12">
						<h1 class="page-header"> Login or Register</h1>
					</div>		
						<div class="col-lg-12" align="center">


		
		<div id="loginContent" class="login" align="center" role="form">
			<div id="loginResult" style="display: none;"></div>
			<form id="loginForm" name="loginForm">
				<p id="result"></p>
				
				<fieldset>
					<legend>
						Enter information
					</legend>
					<div class="form-group">
						<input type="text"
						id="username" name="username" placeholder="username" class="text" size="20" autofocus required/>
					</div>
					<div class="form-group">
						
						<input
						type="password" id="password" name="password" placeholder="password"class="text"
						size="20" required/>
					</div>
					<div class="form-group">
						<input type="submit" class="btn btn-default" value="Login"/>							
					</div>
				</fieldset>
			</form>
			<hr>
			<div class="col-lg-12" align="center">
				<button id="register" type="submit" class="btn btn-default" onclick="registerUser()">
					Register
				</button>			
			
			</div>
			</div>
			</div>
			</div>
			</div>
			</div>
			
			<script>
			window.onload = function(){
				var x = readCookie('usercookie')
				//alert("script! x = " + x)
				if (x) {
					var userID = x.charAt(x.length-2)
					if(userID==-1){
						eraseCookie('usercookie');
					}
					else{	
						window.location.replace("index.html");
					}	
				}
			}
		</script>
			
			<script	src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
			
			<script>
			
				(function($) {
					function processForm(e) {
						$.ajax({
							url : '/dss/rest/users/getuser',
							dataType : 'json',
							type : 'post',
							contentType : 'application/json',
							data : JSON.stringify({
								"username" : $('#username').val(),
								"password" : $('#password').val()
							}),
							processData : false,
							success : function(data, textStatus, jQxhr) {
								if (data != null) {
									createCookie('usercookie', JSON.stringify(data), 0);
									var key = 'libraryPersistentID';
									var elem = document.getElementById("result");
									if (data[key] != -1){
										window.location.replace("index.html");
									}
									else {
										elem.innerHTML = "Login Failed: wrong username or password";
										elem.style.color = 'red';
									}								
								}
								else{
									elem.innerHTML = "Server Error - could not log in";
									elem.style.color = 'red';
									console.log(errorThrown);
								}
							},
							error : function(jqXhr, textStatus, errorThrown) {						
								createCookie('usercookie', JSON.stringify(data), 7);
								document.write('<p>Unknown Error!!!! This should not happen</p><a href ="login.html">Continue</a>');
								console.log(errorThrown);

							}
						});
						e.preventDefault();
					}


					$('#loginForm').submit(processForm);
				})(jQuery);
				
				function registerUser(){
					//var username = document.getElementById('username');
					//var password = document.getElementById('password');
					//var libraryPersistentID = "TEMPORARY";
					(function($){	
					$.ajax({
							url : '/dss/rest/users/',
							dataType : 'json',
							type : 'put',
							contentType : 'application/json',
							data : JSON.stringify({
								"username" : $('#username').val(),
								"password" : $('#password').val(),
								"libraryPersistentID" : "TEMPORARY ID"
							}),
							processData : false,
							success : function(data, textStatus, jQxhr) {
								var elem = document.getElementById("result");	
								if (data != null) {
									createCookie('usercookie', JSON.stringify(data), 0);
									var key = 'libraryPersistentID';									
									if (data[key] != -1){
										//alert("Registration Successful");
										window.location.replace("upload.html");
									}
									else {
										elem.innerHTML = "Login Failed: wrong username or password";
										elem.style.color = 'red';
									}								
								}
								else{
									elem.innerHTML = "Username already exists! Please try another!";
									elem.style.color = 'red';
									console.log(errorThrown);
								}
							},
							error : function(jqXhr, textStatus, errorThrown) {						
								createCookie('usercookie', JSON.stringify(data), 0);
								document.write('<p>Unknown Error!!!! This should not happen</p><a href ="login.html">Continue</a>');
								console.log(errorThrown);

							}
						});
					
					})(jQuery);//end anonymous inner function
				}//end register user	

				function createCookie(name, value, days) {
					if (days) {
						var date = new Date();
						date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
						var expires = "; expires=" + date.toGMTString();
					} else
						var expires = "";
					document.cookie = name + "=" + value + expires + "; path=/";
				}

				function readCookie(name) {
					var nameEQ = name + "=";
					var ca = document.cookie.split(';');
					for (var i = 0; i < ca.length; i++) {
						var c = ca[i];
						while (c.charAt(0) == ' ')
						c = c.substring(1, c.length);
						if (c.indexOf(nameEQ) == 0)
							return c.substring(nameEQ.length, c.length);
					}
					return null;
				}

				function eraseCookie(name) {
					createCookie(name, "", -1);
				}

			</script>

		</div>
	</body>
</html>